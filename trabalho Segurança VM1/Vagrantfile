Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/focal64"
  config.vm.network "private_network", ip: "192.168.50.10"
  config.vm.provision "shell", inline: <<-SHELL
    # 1. Atualizar todos os pacotes do sistema
    apt update && apt upgrade -y

    # 2. Instalar um firewall e permitir apenas conexões SSH
    apt install ufw -y
    ufw default deny incoming
    ufw default allow outgoing
    ufw allow ssh
    ufw enable

    # 3. Desativar root login via SSH
    sed -i 's/PermitRootLogin yes/PermitRootLogin no/g' /etc/ssh/sshd_config

    # 4. Configurar autenticação de chave para SSH
    echo "PubkeyAuthentication yes" >> /etc/ssh/sshd_config
    echo "PasswordAuthentication no" >> /etc/ssh/sshd_config

    # 5. Instalar e configurar o fail2ban
    apt install fail2ban -y
    cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
    service fail2ban restart

    # 6. Desativar IPv6 (se não for necessário)
    echo "net.ipv6.conf.all.disable_ipv6 = 1" >> /etc/sysctl.conf
    echo "net.ipv6.conf.default.disable_ipv6 = 1" >> /etc/sysctl.conf
    echo "net.ipv6.conf.lo.disable_ipv6 = 1" >> /etc/sysctl.conf
    sysctl -p

    # 7. Configurar um limite para o número de processos do sistema
    echo "* hard nproc 4000" >> /etc/security/limits.conf

    # 8. Definir permissões estritas para o home directory
    chmod 0700 /root

    # 9. Remover ou desativar serviços não essenciais
    systemctl disable rpcbind

    # 10. Monitorar eventos do sistema com auditd
    apt install auditd audispd-plugins -y
    service auditd start

  SHELL
end